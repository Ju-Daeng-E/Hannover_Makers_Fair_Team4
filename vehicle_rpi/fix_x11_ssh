#!/bin/bash

# SSH X11 환경 문제 해결 스크립트
echo "🔧 SSH X11 환경 수정 도구"
echo "========================="

# 현재 환경 확인
echo "📋 현재 환경:"
echo "DISPLAY: $DISPLAY"
echo "SSH_CLIENT: ${SSH_CLIENT:-"Not SSH"}"

if [ -z "$DISPLAY" ]; then
    echo "❌ DISPLAY가 설정되지 않았습니다"
    echo "💡 SSH 재연결: ssh -Y username@hostname"
    exit 1
fi

# X11 환경 변수 설정
echo "🔧 X11 환경 변수 설정..."

# Qt 관련 설정
export QT_QPA_PLATFORM=xcb
export QT_X11_NO_MITSHM=1
export QT_LOGGING_RULES="*=false"

# OpenGL 관련 설정 (SSH용)
export LIBGL_ALWAYS_INDIRECT=1
export MESA_GL_VERSION_OVERRIDE=3.3

# OpenCV 관련 설정
export OPENCV_IO_ENABLE_OPENEXR=0

echo "✅ 환경 변수 설정 완료"
echo "📋 설정된 변수들:"
echo "QT_QPA_PLATFORM=$QT_QPA_PLATFORM"
echo "QT_X11_NO_MITSHM=$QT_X11_NO_MITSHM"
echo "LIBGL_ALWAYS_INDIRECT=$LIBGL_ALWAYS_INDIRECT"

# X11 연결 테스트
echo "🧪 X11 연결 테스트..."
if command -v xdpyinfo &> /dev/null; then
    if xdpyinfo &> /dev/null; then
        echo "✅ X11 연결 정상"
    else
        echo "❌ X11 연결 실패"
        echo "💡 Windows: VcXsrv 실행 확인"
        echo "💡 macOS: XQuartz 실행 확인"
        echo "💡 Linux: X11 서버 실행 확인"
    fi
else
    echo "⚠️ xdpyinfo 없음 (정상)"
fi

echo "========================="
echo "🚀 이제 카메라 GUI를 실행하세요:"
echo "   python3 camera_simple_gui.py"
echo "   또는"
echo "   python3 camera_gui.py"